<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multi-User Tracking</title>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <!-- Leaflet Routing & Geocoder -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <style>
    #map {
      height: 100vh;
    }
    .status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 8px;
      border-radius: 5px;
      z-index: 1000;
    }
    /* Emergency marker icons styles */
    .emergency-icon {
      border-radius: 50%;
      border: 2px solid white;
      background-color: red;
      width: 30px;
      height: 30px;
      display: block;
    }
  </style>
</head>
<body>

  <div id="map"></div>
  <div id="status" class="status">Waiting for data...</div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js';
    import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js';

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBtraV34vofWZK_d8gcZPRP0U7TgYIuXW4",
      authDomain: "firefinder-d5c0a.firebaseapp.com",
      projectId: "firefinder-d5c0a",
      storageBucket: "firefinder-d5c0a.appspot.com",
      messagingSenderId: "221428549294",
      appId: "1:221428549294:web:be5a7164bb363eaf9e0f3f",
      databaseURL: "https://firefinder-d5c0a-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Map Initialization
    const map = L.map('map').setView([14.832, 120.282], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const gordonCollegeLatLng = L.latLng(14.832005, 120.282648);
    L.marker(gordonCollegeLatLng).addTo(map).bindPopup("Gordon College");

    // Green alert icon for user locations
    const greenIcon = L.icon({
      iconUrl: 'alert.png',
      iconSize: [60, 60],
      iconAnchor: [30, 60],
      popupAnchor: [0, -60]
    });

    // Status update element
    const statusElement = document.getElementById('status');
    function updateStatus(msg, type = 'info') {
      statusElement.textContent = msg;
    }

    // Refs to store markers/routes per user
    const userMarkers = {};
    const userRoutes = {};

    // Listen to multiple user locations
    const locationsRef = ref(db, 'locations');
    onValue(locationsRef, (snapshot) => {
      const data = snapshot.val();

      if (data) {
        const userCount = Object.keys(data).length;

        Object.entries(data).forEach(([userId, coords]) => {
          const latLng = L.latLng(coords.latitude, coords.longitude);

          // Create or update marker
          if (userMarkers[userId]) {
            userMarkers[userId].setLatLng(latLng);
          } else {
            userMarkers[userId] = L.marker(latLng, { icon: greenIcon })
              .addTo(map)
              .bindPopup(`User: ${userId}`);
          }

          // Remove old route
          if (userRoutes[userId]) {
            map.removeControl(userRoutes[userId]);
          }

          // Add new route
          userRoutes[userId] = L.Routing.control({
            waypoints: [gordonCollegeLatLng, latLng],
            routeWhileDragging: false,
            geocoder: L.Control.Geocoder.nominatim(),
            createMarker: () => null,
            show: false
          }).addTo(map);
        });

        updateStatus(`Tracking ${userCount} user(s)`);
      } else {
        updateStatus("No active locations.");
      }
    });


    // ========== New code added here for live emergency reports ==========

    // Custom icons for emergencies
    const emergencyIcons = {
      fire: L.icon({
        iconUrl: 'fire-icon.png', // supply your fire icon image path
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40],
      }),
      medical: L.icon({
        iconUrl: 'medical-icon.png', // supply your medical icon image path
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40],
      }),
      accident: L.icon({
        iconUrl: 'accident-icon.png', // supply your accident icon image path
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40],
      }),
    };

    // Store emergency markers by report id
    const reportMarkers = {};

    const reportsRef = ref(db, 'reports');
    onValue(reportsRef, (snapshot) => {
      const reports = snapshot.val();

      // Remove previous markers for removed reports
      for (const id in reportMarkers) {
        if (!reports || !reports[id]) {
          map.removeLayer(reportMarkers[id]);
          delete reportMarkers[id];
        }
      }

      if (reports) {
        Object.entries(reports).forEach(([id, report]) => {
          const latLng = L.latLng(report.latitude, report.longitude);

          // If marker exists update, else create new
          if (reportMarkers[id]) {
            reportMarkers[id].setLatLng(latLng);
          } else {
            const icon = emergencyIcons[report.emergencyType.toLowerCase()] || emergencyIcons.fire;

            let popupContent = `<b>Emergency: ${report.emergencyType}</b><br>`;
            popupContent += `<b>Message:</b> ${report.message || 'No message'}<br>`;

            if (report.imageUrl) {
              popupContent += `<img src="${report.imageUrl}" alt="Report Image" style="max-width:150px; max-height:150px; margin-top:5px;">`;
            }

            popupContent += `<br><small>Reported at: ${new Date(report.timestamp).toLocaleString()}</small>`;

            reportMarkers[id] = L.marker(latLng, { icon }).addTo(map).bindPopup(popupContent);
          }
        });
      }
    });

  </script>
</body>
</html>
