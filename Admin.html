<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - Emergency Reports</title>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <!-- Routing & Geocoder -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    
    #map { 
      height: 100vh; 
      width: 70%;
      float: left;
    }
    
    #reports-panel {
      width: 30%;
      height: 100vh;
      float: right;
      overflow-y: auto;
      background: #f5f5f5;
      padding: 10px;
      box-sizing: border-box;
    }
    
    .status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 8px;
      border-radius: 5px;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .report-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .report-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .report-card.active {
      border-left: 4px solid #e74c3c;
      background: #fff9f9;
    }
    
    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .report-type {
      font-weight: bold;
      color: #e74c3c;
      text-transform: capitalize;
    }
    
    .report-time {
      font-size: 0.8em;
      color: #777;
    }
    
    .report-user {
      font-size: 0.9em;
      color: #555;
      margin-bottom: 8px;
    }
    
    .report-message {
      margin-bottom: 10px;
      line-height: 1.4;
    }
    
    .report-image {
      max-width: 100%;
      max-height: 150px;
      border-radius: 4px;
      margin-top: 10px;
    }
    
    .panel-header {
      padding: 15px;
      background: #e74c3c;
      color: white;
      font-weight: bold;
      text-align: center;
      margin: -10px -10px 10px -10px;
    }
    
    .no-reports {
      text-align: center;
      padding: 20px;
      color: #777;
    }
    
    .action-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    
    .action-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
    }
    
    .view-btn {
      background: #3498db;
      color: white;
    }
    
    .resolve-btn {
      background: #2ecc71;
      color: white;
    }
    
    .clearfix::after {
      content: "";
      clear: both;
      display: table;
    }
    
    @media (max-width: 768px) {
      #map, #reports-panel {
        width: 100%;
        height: 50vh;
      }
    }
  </style>
</head>
<body>

<div class="clearfix">
  <div id="map"></div>
  <div id="reports-panel">
    <div class="panel-header">
      <i class="fas fa-exclamation-triangle"></i> Emergency Reports
    </div>
    <div id="reports-list"></div>
  </div>
</div>

<div id="status" class="status">Initializing...</div>

<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBtraV34vofWZK_d8gcZPRP0U7TgYIuXW4",
    authDomain: "firefinder-d5c0a.firebaseapp.com",
    databaseURL: "https://firefinder-d5c0a-default-rtdb.firebaseio.com",
    projectId: "firefinder-d5c0a",
    storageBucket: "firefinder-d5c0a.appspot.com",
    messagingSenderId: "221428549294",
    appId: "1:221428549294:web:be5a7164bb363eaf9e0f3f"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Initialize map
  const map = L.map('map').setView([14.832, 120.282], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const gordonCollegeLatLng = L.latLng(14.832005, 120.282648);
  L.marker(gordonCollegeLatLng).addTo(map).bindPopup("Gordon College");

  const statusEl = document.getElementById('status');
  const reportsList = document.getElementById('reports-list');
  const reportMarkers = {}; // To store markers for each report

  function updateStatus(msg) {
    console.log('Status:', msg);
    statusEl.textContent = msg;
  }

  function formatTimestamp(timestamp) {
    if (!timestamp) return 'Unknown time';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleString();
  }

  function createReportCard(report, id) {
    const reportCard = document.createElement('div');
    reportCard.className = 'report-card';
    reportCard.dataset.reportId = id;
    reportCard.onclick = () => focusReport(id);
    
    const header = document.createElement('div');
    header.className = 'report-header';
    
    const type = document.createElement('div');
    type.className = 'report-type';
    type.textContent = report.emergencyType || 'Emergency';
    header.appendChild(type);
    
    const time = document.createElement('div');
    time.className = 'report-time';
    time.textContent = formatTimestamp(report.timestamp);
    header.appendChild(time);
    
    reportCard.appendChild(header);
    
    const message = document.createElement('div');
    message.className = 'report-message';
    message.textContent = report.message || 'No additional details provided';
    reportCard.appendChild(message);
    
    if (report.imageBase64) {
      const img = document.createElement('img');
      img.className = 'report-image';
      img.src = report.imageBase64;
      img.alt = "Report image";
      reportCard.appendChild(img);
    }
    
    const actions = document.createElement('div');
    actions.className = 'action-buttons';
    
    const viewBtn = document.createElement('button');
    viewBtn.className = 'action-btn view-btn';
    viewBtn.innerHTML = '<i class="fas fa-eye"></i> View';
    viewBtn.onclick = (e) => {
      e.stopPropagation();
      focusReport(id);
    };
    actions.appendChild(viewBtn);
    
    const resolveBtn = document.createElement('button');
    resolveBtn.className = 'action-btn resolve-btn';
    resolveBtn.innerHTML = '<i class="fas fa-check"></i> Resolve';
    resolveBtn.onclick = (e) => {
      e.stopPropagation();
      resolveReport(id);
    };
    actions.appendChild(resolveBtn);
    
    reportCard.appendChild(actions);
    
    return reportCard;
  }

  function focusReport(reportId) {
    if (reportMarkers[reportId]) {
      // Highlight the card
      document.querySelectorAll('.report-card').forEach(card => {
        card.classList.remove('active');
      });
      document.querySelector(`.report-card[data-report-id="${reportId}"]`).classList.add('active');
      
      // Center map on marker
      map.setView(reportMarkers[reportId].getLatLng(), 16);
    }
  }

  function resolveReport(reportId) {
    if (!confirm('Mark this report as resolved?')) return;
    
    db.collection('reports').doc(reportId).update({
      status: 'resolved',
      resolvedAt: new Date()
    }).then(() => {
      console.log('Report marked as resolved');
      if (reportMarkers[reportId]) {
        map.removeLayer(reportMarkers[reportId]);
        delete reportMarkers[reportId];
      }
    }).catch(error => {
      console.error('Error resolving report:', error);
      alert('Failed to resolve report: ' + error.message);
    });
  }

  // Listen for new reports
  db.collection('reports')
    .orderBy('timestamp', 'desc')
    .onSnapshot(snapshot => {
      reportsList.innerHTML = '';
      
      snapshot.docChanges().forEach(change => {
        const report = change.doc.data();
        const reportId = change.doc.id;
        
        if (change.type === 'removed') {
          // Remove marker if report was deleted
          if (reportMarkers[reportId]) {
            map.removeLayer(reportMarkers[reportId]);
            delete reportMarkers[reportId];
          }
          return;
        }
        
        // Skip resolved reports
        if (report.status === 'resolved') return;
        
        // Create or update marker
        if (!reportMarkers[reportId] && report.latitude && report.longitude) {
          const marker = L.marker([report.latitude, report.longitude])
            .addTo(map)
            .bindPopup(`<b>${report.emergencyType || 'Emergency'}</b><br>${report.message || ''}`);
          
          reportMarkers[reportId] = marker;
        }
        
        // Add report card
        const card = createReportCard(report, reportId);
        reportsList.appendChild(card);
      });
      
      if (snapshot.empty) {
        reportsList.innerHTML = '<div class="no-reports">No active emergency reports</div>';
      }
      
      updateStatus(`Loaded ${snapshot.size} reports`);
    }, error => {
      console.error('Error listening to reports:', error);
      updateStatus('Error loading reports');
      reportsList.innerHTML = '<div class="no-reports">Error loading reports</div>';
    });
</script>
</body>
</html>
