<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Location Picker with Route</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <!-- Leaflet Routing Machine -->
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <!-- Leaflet Geocoder -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background-color: #f5f6fa; 
    }
    .container { 
      max-width: 1000px; 
      margin: auto; 
    }
    .input-section {
      background: white; 
      padding: 20px; 
      border-radius: 10px;
      margin-bottom: 20px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .map-container { 
      position: relative; 
      height: 500px; /* Fixed height */
      width: 100%;   /* Ensure width is set */
      display: flex; 
    }
    #map { 
      flex: 1; 
      height: 100%; 
      width: 100%;
      border-radius: 10px; 
      background-color: #eee; /* Fallback color */
    }
    /* Rest of your CSS remains the same */
  </style>
</head>
<body>
  <div class="container">
    <div class="input-section" id="inputForm">
      <h2>Select & Save Your Location</h2>
      <input type="text" id="locationName" placeholder="Enter a name for the location">
      <button id="saveButton" onclick="saveLocation()" disabled>Save Location</button>
      <div id="status" class="status info" aria-live="polite">Click on the map to select a location.</div>
    </div>

    <div class="map-container">
      <button class="icon-button" id="dirBtn" onclick="toggleDirections()" title="Toggle Directions">ðŸ§­</button>
      <div id="map"></div>
      <div class="directions-panel" id="directionsPanel"></div>
    </div>
  </div>

  <script>
    // First, ensure the map container exists and has dimensions
    document.addEventListener('DOMContentLoaded', function() {
      const mapContainer = document.getElementById('map');
      if (!mapContainer) {
        console.error("Map container not found!");
        return;
      }
      
      console.log("Map container dimensions:", mapContainer.offsetWidth, "x", mapContainer.offsetHeight);
      
      // Initialize Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyBtraV34vofWZK_d8gcZPRP0U7TgYIuXW4",
        authDomain: "firefinder-d5c0a.firebaseapp.com",
        databaseURL: "https://firefinder-d5c0a-default-rtdb.firebaseio.com",
        projectId: "firefinder-d5c0a",
        storageBucket: "firefinder-d5c0a.firebasestorage.app",
        messagingSenderId: "221428549294",
        appId: "1:221428549294:web:be5a7164bb363eaf9e0f3f"
      };
      
      try {
        firebase.initializeApp(firebaseConfig);
      } catch (error) {
        console.error("Firebase initialization error:", error);
      }
      
      const database = firebase.database();

      // Dispatcher Location (Gordon College)
      const dispatcherLatLng = { lat: 14.832005, lng: 120.282648 };

      // Initialize the map with error handling
      let map;
      try {
        map = L.map('map').setView([dispatcherLatLng.lat, dispatcherLatLng.lng], 15);
        
        // Add tile layer with error handling
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        console.log("Map initialized successfully");
        
        // Add dispatcher's marker to the map
        const dispatcherMarker = L.marker([dispatcherLatLng.lat, dispatcherLatLng.lng])
          .addTo(map)
          .bindPopup("Dispatcher Location (Gordon College)");
          
        // Test marker to verify map is working
        L.marker([dispatcherLatLng.lat + 0.01, dispatcherLatLng.lng + 0.01])
          .addTo(map)
          .bindPopup("Test Marker - If you see this, the map is working")
          .openPopup();
          
      } catch (error) {
        console.error("Map initialization error:", error);
        document.getElementById('status').textContent = "Error loading map. Please check console for details.";
        return;
      }

      let selectedLocation = null;
      let marker = null;
      let routeControl = null;
      const saveButton = document.getElementById('saveButton');
      const statusElement = document.getElementById('status');

      // Function to update status messages
      function updateStatus(msg = '', type = 'info') {
        statusElement.textContent = msg;
        statusElement.className = 'status ' + type;
      }

      // Toggle directions panel
      function toggleDirections() {
        const panel = document.getElementById('directionsPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      }

      // Event listener for map click (select location)
      map.on('click', function(e) {
        selectedLocation = e.latlng;
        if (marker) map.removeLayer(marker);
        marker = L.marker(selectedLocation).addTo(map)
                 .bindPopup("Selected Location")
                 .openPopup();
        saveButton.disabled = false;
        updateStatus("Location selected. Click 'Save Location' to save.", "success");
      });

      // Save location to Firebase
      function saveLocation() {
        if (!selectedLocation) {
          updateStatus("No location selected.", "error");
          return;
        }

        const nameInput = document.getElementById("locationName").value.trim();
        const name = nameInput || "Unnamed Location";
        const locationData = {
          name: name,
          latitude: selectedLocation.lat,
          longitude: selectedLocation.lng,
          timestamp: Date.now()
        };

        saveButton.disabled = true;
        updateStatus("Saving location...", "info");

        database.ref("Locations").push(locationData).then(() => {
          updateStatus("Location saved successfully!", "success");
          document.getElementById("inputForm").style.display = "none";
          showRouteTo(selectedLocation.lat, selectedLocation.lng);
        }).catch(error => {
          console.error("Error saving location: ", error);
          updateStatus(`Failed to save location: ${error.message}`, "error");
          saveButton.disabled = false;
        });
      }

      function showRouteTo(userLat, userLng) {
        const dispatcher = L.latLng(dispatcherLatLng.lat, dispatcherLatLng.lng);
        const userLocation = L.latLng(userLat, userLng);

        // Debugging: Log waypoints
        console.log("Dispatcher Location:", dispatcher);
        console.log("User Location:", userLocation);

        // Check if waypoints are valid
        if (!dispatcher || !userLocation) {
          console.error("Invalid waypoints for routing.");
          updateStatus("Failed to create route: Invalid waypoints.", "error");
          return;
        }

        // Remove previous route if it exists
        if (routeControl) {
          map.removeControl(routeControl);
        }

        // Create new routing control
        routeControl = L.Routing.control({
          waypoints: [dispatcher, userLocation],
          routeWhileDragging: true,
          geocoder: L.Control.Geocoder.nominatim(),
          show: false, // Don't show the default control panel
          createMarker: function(i, waypoint) {
            // Skip creating additional markers (we already have them)
            return null;
          },
          itinerary: {
            container: document.getElementById('directionsPanel')
          }
        })
          .on('routesfound', function(e) {
            console.log("Route found:", e.routes[0]);
            updateStatus("Route successfully created.", "success");
            document.getElementById("directionsPanel").style.display = "block";
          })
          .on('routingerror', function(e) {
            console.error("Routing error:", e);
            updateStatus("Failed to create route. Please try again.", "error");
          })
          .addTo(map);
      }
    });
  </script>
</body>
</html>
