<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Location Picker with Route</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- Leaflet and Routing -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

  <style>
    body { font-family: Arial; margin: 0; padding: 20px; background: #f5f6fa; }
    #map { height: 400px; border-radius: 8px; }
    input, button {
      width: 100%; padding: 10px; margin-top: 10px;
      border-radius: 6px; border: 1px solid #ccc;
    }
    button { background-color: #273c75; color: white; font-weight: bold; border: none; }
    #status { margin-top: 10px; font-size: 14px; }
  </style>
</head>
<body>

  <h2>Click on the Map to Select a Location</h2>
  <input type="text" id="locationName" placeholder="Enter location name" />
  <button id="saveBtn" onclick="saveLocation()" disabled>Save Location</button>
  <div id="status">Waiting for location selection...</div>
  <div id="map"></div>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBtraV34vofWZK_d8gcZPRP0U7TgYIuXW4",
      authDomain: "firefinder-d5c0a.firebaseapp.com",
      databaseURL: "https://firefinder-d5c0a-default-rtdb.firebaseio.com",
      projectId: "firefinder-d5c0a",
      storageBucket: "firefinder-d5c0a.firebasestorage.app",
      messagingSenderId: "221428549294",
      appId: "1:221428549294:web:be5a7164bb363eaf9e0f3f"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const map = L.map('map').setView([14.8292, 120.2820], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let marker, selectedLatLng, routeControl;

    map.on('click', function(e) {
      selectedLatLng = e.latlng;
      if (marker) map.removeLayer(marker);
      marker = L.marker(selectedLatLng).addTo(map).bindPopup("Selected").openPopup();
      document.getElementById("saveBtn").disabled = false;
      updateStatus("Location selected. Ready to save.");
    });

    function saveLocation() {
      if (!selectedLatLng) return updateStatus("Please select a location first.");
      const name = document.getElementById("locationName").value.trim() || "Unnamed";
      const locationData = {
        name: name,
        latitude: selectedLatLng.lat,
        longitude: selectedLatLng.lng,
        timestamp: Date.now()
      };

      updateStatus("Saving location...");
      firebase.database().ref("Locations").push(locationData)
        .then(() => {
          updateStatus("Location saved! Drawing route...");
          drawRouteTo(selectedLatLng.lat, selectedLatLng.lng);
        })
        .catch(err => {
          console.error(err);
          updateStatus("Error saving location.");
        });
    }

    function drawRouteTo(destLat, destLng) {
      if (!navigator.geolocation) return alert("Geolocation not supported.");
      navigator.geolocation.getCurrentPosition(pos => {
        const userLatLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
        const destination = L.latLng(destLat, destLng);

        if (routeControl) map.removeControl(routeControl);

        routeControl = L.Routing.control({
          waypoints: [userLatLng, destination],
          routeWhileDragging: false,
          createMarker: () => null,
          router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' })
        }).addTo(map);

        updateStatus("Route displayed. Redirecting in 3 seconds...");
        setTimeout(() => window.location.href = "user.html", 3000);

      }, err => {
        console.error(err);
        alert("Failed to get location.");
      });
    }

    function updateStatus(msg) {
      document.getElementById("status").textContent = msg;
    }
  </script>

</body>
</html>
