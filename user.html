<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CIVILIAN Report</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 60vh;
      width: 100%;
    }
    .sidebar {
      padding: 10px;
    }
    .toggle-button {
      margin: 5px 5px 10px 0;
      padding: 8px 15px;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #f0f0f0;
    }
    .toggle-button.selected {
      background: #d32f2f;
      color: white;
      border-color: #b71c1c;
    }
    textarea {
      width: 100%;
      height: 80px;
      margin-bottom: 10px;
    }
    button {
      background-color: #d32f2f;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-weight: bold;
      border-radius: 5px;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div class="sidebar">
    <h2>Whatâ€™s the Emergency?</h2>
    <div>
      <button class="toggle-button" id="fire-btn">FIRE</button>
      <button class="toggle-button" id="accident-btn">ACCIDENT</button>
      <button class="toggle-button" id="medical-btn">MEDICAL</button>
    </div>
    <textarea id="message" placeholder="Type your message here..."></textarea>
    <input type="file" id="image-uploader" accept="image/*" />
    <br />
    <button id="report-btn">REPORT to FDP</button>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBtraV34vofWZK_d8gcZPRP0U7TgYIuXW4",
      authDomain: "firefinder-d5c0a.firebaseapp.com",
      databaseURL: "https://firefinder-d5c0a-default-rtdb.firebaseio.com",
      projectId: "firefinder-d5c0a",
      storageBucket: "firefinder-d5c0a.appspot.com",
      messagingSenderId: "221428549294",
      appId: "1:221428549294:web:be5a7164bb363eaf9e0f3f",
    };
    firebase.initializeApp(firebaseConfig);

    const database = firebase.database();
    const storage = firebase.storage();

    // Leaflet map setup
    const map = L.map('map').setView([14.8292, 120.2820], 14.5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let selectedLocation = null;
    let marker = null;

    map.on('click', function (e) {
      selectedLocation = e.latlng;
      if (marker) {
        map.removeLayer(marker);
      }
      marker = L.marker(selectedLocation).addTo(map).bindPopup('Selected Location').openPopup();
    });

    // Emergency buttons
    const emergencyButtons = document.querySelectorAll('.toggle-button');
    let selectedEmergency = null;
    emergencyButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        emergencyButtons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedEmergency = btn.textContent.trim();
      });
    });

    // Report button logic
    const reportBtn = document.getElementById('report-btn');
    const messageInput = document.getElementById('message');
    const imageUploader = document.getElementById('image-uploader');

    reportBtn.addEventListener('click', async () => {
      if (!selectedEmergency) {
        alert('Please select an emergency type.');
        return;
      }
      if (!selectedLocation) {
        alert('Please select a location on the map.');
        return;
      }
      const message = messageInput.value.trim();
      if (!message) {
        alert('Please type your message.');
        return;
      }

      reportBtn.disabled = true;
      reportBtn.textContent = 'Reporting...';

      try {
        let imageUrl = "";
        const file = imageUploader.files[0];
        if (file) {
          const fileName = Date.now() + '_' + file.name;
          const storageRef = storage.ref('reports/' + fileName);
          await storageRef.put(file);
          imageUrl = await storageRef.getDownloadURL();
        }

        const reportData = {
          emergencyType: selectedEmergency,
          message: message,
          latitude: selectedLocation.lat,
          longitude: selectedLocation.lng,
          imageUrl: imageUrl,
          timestamp: Date.now()
        };

        await database.ref('reports').push(reportData);

        alert('Report submitted successfully!');

        // Reset UI
        messageInput.value = "";
        imageUploader.value = "";
        selectedEmergency = null;
        emergencyButtons.forEach(b => b.classList.remove('selected'));
        if (marker) {
          map.removeLayer(marker);
          marker = null;
          selectedLocation = null;
        }
      } catch (err) {
        alert('Failed to report: ' + err.message);
      } finally {
        reportBtn.disabled = false;
        reportBtn.textContent = 'REPORT to FDP';
      }
    });
  </script>
</body>

</html>
